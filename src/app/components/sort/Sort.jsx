import { useState, useRef, useEffect } from 'react';
import './Sort.css';
import { Dropdown } from '../dropdown/Dropdown';

// Sort: Dropdown component for sorting sites by date or alphabetically
export const Sort = ({ onSortChange }) => {
  // Get initial sort mode from localStorage or default to alphabetical
  const getInitialSortMode = () => {
    if (typeof window !== 'undefined' && window.localStorage) {
      return localStorage.getItem('sortMode') || 'alphabetical';
    }
    return 'alphabetical';
  };

  // Get initial sort direction from localStorage or default to ascending
  const getInitialAscending = () => {
    if (typeof window !== 'undefined' && window.localStorage) {
      const stored = localStorage.getItem('sortAscending');
      return stored === null ? true : stored === 'true';
    }
    return true;
  };

  const [sortMode, setSortMode] = useState(getInitialSortMode);
  const [ascending, setAscending] = useState(getInitialAscending);
  const [open, setOpen] = useState(false);
  const buttonRef = useRef(null);

  // Initialize sort on component mount
  useEffect(() => {
    onSortChange(sortMode, ascending);
  }, []);

  // Handle sort option selection
  const handleSortChange = (mode, direction) => {
    setSortMode(mode);
    setAscending(direction);
    localStorage.setItem('sortMode', mode);
    localStorage.setItem('sortAscending', direction);
    onSortChange(mode, direction);
    setOpen(false);
  };

  // Sort button trigger
  const SortTrigger = (
    <div className="sort__button" ref={buttonRef} onClick={() => setOpen(v => !v)}>
      Sort
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="#000000" fill="none">
        <path d="M7.75001 19.9999C7.75001 20.5522 7.30229 20.9999 6.75001 20.9999C6.19773 20.9999 5.75001 20.5522 5.75001 19.9999V7.99999L4.56829 8L4.53443 8.00003H4.53442C4.39798 8.00025 4.19919 8.00056 4.02998 7.9746C3.84511 7.94624 3.36011 7.83812 3.11374 7.32267C2.86919 6.81104 3.08093 6.36183 3.17545 6.19364C3.26004 6.04314 3.38325 5.88606 3.46679 5.77954L3.48764 5.75295C3.83845 5.3042 4.34774 4.67868 4.85106 4.15775C5.10066 3.89942 5.3718 3.64263 5.63789 3.44332C5.77108 3.34356 5.92353 3.24258 6.08808 3.16319C6.24265 3.08862 6.47491 3 6.74999 3C7.02506 3 7.25731 3.08862 7.41188 3.16319C7.57642 3.24258 7.72888 3.34356 7.86206 3.44332C8.12815 3.64263 8.3993 3.89941 8.6489 4.15774C9.15222 4.67866 9.66152 5.30417 10.0123 5.75291L10.0332 5.77951L10.0332 5.77952C10.1167 5.88603 10.24 6.04311 10.3245 6.19361C10.4191 6.36179 10.6308 6.811 10.3863 7.32264C10.1399 7.83809 9.65489 7.94621 9.47003 7.97458C9.30081 8.00054 9.10202 8.00023 8.96557 8.00002L8.93172 7.99998L7.75001 7.99998V19.9999Z" fill="currentColor" />
        <path d="M18.25 4.00006C18.25 3.44778 17.8023 3.00006 17.25 3.00006C16.6977 3.00006 16.25 3.44778 16.25 4.00006V16L15.0683 16L15.0344 16H15.0344C14.898 15.9998 14.6992 15.9994 14.53 16.0254C14.3451 16.0538 13.8601 16.1619 13.6137 16.6773C13.3692 17.189 13.5809 17.6382 13.6755 17.8064C13.76 17.9569 13.8832 18.1139 13.9668 18.2205L13.9876 18.2471C14.3385 18.6958 14.8477 19.3213 15.3511 19.8422C15.6007 20.1006 15.8718 20.3574 16.1379 20.5567C16.2711 20.6564 16.4235 20.7574 16.5881 20.8368C16.7426 20.9114 16.9749 21 17.25 21C17.5251 21 17.7573 20.9114 17.9119 20.8368C18.0764 20.7574 18.2289 20.6564 18.3621 20.5567C18.6282 20.3574 18.8993 20.1006 19.1489 19.8423C19.6522 19.3213 20.1615 18.6958 20.5123 18.2471L20.5332 18.2205L20.5332 18.2205C20.6167 18.114 20.74 17.9569 20.8245 17.8064C20.9191 17.6382 21.1308 17.189 20.8863 16.6774C20.6399 16.1619 20.1549 16.0538 19.97 16.0254C19.8008 15.9995 19.602 15.9998 19.4656 16L19.4317 16L18.25 16V4.00006Z" fill="currentColor" />
      </svg>
    </div>
  );

  // Sort dropdown menu content
  const SortMenu = (
    <>
      <div className="sort__title">Date</div>
      <button 
        className="dropdown__item"
        onClick={(e) => { e.stopPropagation(); handleSortChange('date', false); }}
      >
        Newer
        {sortMode === 'date' && !ascending && (
          <span className="dropdown__icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="currentColor" fill="none">
              <path fillRule="evenodd" clipRule="evenodd" d="M19.9378 5.65241C20.1299 6.1702 19.8659 6.7457 19.3481 6.93782C18.2893 7.33068 17.1276 8.14841 15.9516 9.22885C14.7868 10.299 13.6643 11.574 12.6796 12.8107C11.6968 14.0449 10.8633 15.2254 10.2753 16.0981C9.98166 16.5339 9.75008 16.8917 9.59261 17.1394C9.51389 17.2632 9.45374 17.3594 9.41368 17.424L9.36885 17.4966L9.35809 17.5142L9.35569 17.5182C9.16686 17.8294 8.82329 18.0143 8.45951 17.9994C8.09567 17.9846 7.76866 17.7732 7.60581 17.4475C6.92848 16.0928 6.15935 15.3411 5.59956 14.934C5.31727 14.7287 5.08223 14.6067 4.93004 14.5391C4.85386 14.5052 4.79837 14.485 4.76806 14.4747C4.75528 14.4703 4.74701 14.4678 4.74357 14.4668C4.2162 14.3269 3.89733 13.7888 4.03009 13.2577C4.16404 12.7219 4.70698 12.3962 5.24277 12.5301C5.26751 12.5366 5.24397 12.5304 5.24397 12.5304L5.24521 12.5307L5.24783 12.5314L5.25365 12.5329L5.26751 12.5366C5.27773 12.5394 5.28991 12.5428 5.30396 12.5469C5.33206 12.5551 5.36767 12.5662 5.41014 12.5805C5.49507 12.6093 5.60755 12.6516 5.74231 12.7115C6.01199 12.8313 6.37071 13.0218 6.77591 13.3165C7.31867 13.7113 7.93487 14.2857 8.52893 15.1112C8.55757 15.0684 8.58683 15.0249 8.6167 14.9805C9.22537 14.0772 10.0905 12.8515 11.115 11.5648C12.1376 10.2807 13.3313 8.92028 14.5985 7.75607C15.8545 6.60213 17.2406 5.58653 18.6524 5.06272C19.1702 4.87061 19.7457 5.13462 19.9378 5.65241Z" fill="currentColor" />
            </svg>
          </span>
        )}
      </button>
      <button 
        className="dropdown__item"
        onClick={(e) => { e.stopPropagation(); handleSortChange('date', true); }}
      >
        Older
        {sortMode === 'date' && ascending && (
          <span className="dropdown__icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="currentColor" fill="none">
              <path fillRule="evenodd" clipRule="evenodd" d="M19.9378 5.65241C20.1299 6.1702 19.8659 6.7457 19.3481 6.93782C18.2893 7.33068 17.1276 8.14841 15.9516 9.22885C14.7868 10.299 13.6643 11.574 12.6796 12.8107C11.6968 14.0449 10.8633 15.2254 10.2753 16.0981C9.98166 16.5339 9.75008 16.8917 9.59261 17.1394C9.51389 17.2632 9.45374 17.3594 9.41368 17.424L9.36885 17.4966L9.35809 17.5142L9.35569 17.5182C9.16686 17.8294 8.82329 18.0143 8.45951 17.9994C8.09567 17.9846 7.76866 17.7732 7.60581 17.4475C6.92848 16.0928 6.15935 15.3411 5.59956 14.934C5.31727 14.7287 5.08223 14.6067 4.93004 14.5391C4.85386 14.5052 4.79837 14.485 4.76806 14.4747C4.75528 14.4703 4.74701 14.4678 4.74357 14.4668C4.2162 14.3269 3.89733 13.7888 4.03009 13.2577C4.16404 12.7219 4.70698 12.3962 5.24277 12.5301C5.26751 12.5366 5.24397 12.5304 5.24397 12.5304L5.24521 12.5307L5.24783 12.5314L5.25365 12.5329L5.26751 12.5366C5.27773 12.5394 5.28991 12.5428 5.30396 12.5469C5.33206 12.5551 5.36767 12.5662 5.41014 12.5805C5.49507 12.6093 5.60755 12.6516 5.74231 12.7115C6.01199 12.8313 6.37071 13.0218 6.77591 13.3165C7.31867 13.7113 7.93487 14.2857 8.52893 15.1112C8.55757 15.0684 8.58683 15.0249 8.6167 14.9805C9.22537 14.0772 10.0905 12.8515 11.115 11.5648C12.1376 10.2807 13.3313 8.92028 14.5985 7.75607C15.8545 6.60213 17.2406 5.58653 18.6524 5.06272C19.1702 4.87061 19.7457 5.13462 19.9378 5.65241Z" fill="currentColor" />
            </svg>
          </span>
        )}
      </button>
      <div className="sort__title">Alphabetical</div>
      <button 
        className="dropdown__item"
        onClick={(e) => { e.stopPropagation(); handleSortChange('alphabetical', true); }}
      >
        A-Z
        {sortMode === 'alphabetical' && ascending && (
          <span className="dropdown__icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="currentColor" fill="none">
              <path fillRule="evenodd" clipRule="evenodd" d="M19.9378 5.65241C20.1299 6.1702 19.8659 6.7457 19.3481 6.93782C18.2893 7.33068 17.1276 8.14841 15.9516 9.22885C14.7868 10.299 13.6643 11.574 12.6796 12.8107C11.6968 14.0449 10.8633 15.2254 10.2753 16.0981C9.98166 16.5339 9.75008 16.8917 9.59261 17.1394C9.51389 17.2632 9.45374 17.3594 9.41368 17.424L9.36885 17.4966L9.35809 17.5142L9.35569 17.5182C9.16686 17.8294 8.82329 18.0143 8.45951 17.9994C8.09567 17.9846 7.76866 17.7732 7.60581 17.4475C6.92848 16.0928 6.15935 15.3411 5.59956 14.934C5.31727 14.7287 5.08223 14.6067 4.93004 14.5391C4.85386 14.5052 4.79837 14.485 4.76806 14.4747C4.75528 14.4703 4.74701 14.4678 4.74357 14.4668C4.2162 14.3269 3.89733 13.7888 4.03009 13.2577C4.16404 12.7219 4.70698 12.3962 5.24277 12.5301C5.26751 12.5366 5.24397 12.5304 5.24397 12.5304L5.24521 12.5307L5.24783 12.5314L5.25365 12.5329L5.26751 12.5366C5.27773 12.5394 5.28991 12.5428 5.30396 12.5469C5.33206 12.5551 5.36767 12.5662 5.41014 12.5805C5.49507 12.6093 5.60755 12.6516 5.74231 12.7115C6.01199 12.8313 6.37071 13.0218 6.77591 13.3165C7.31867 13.7113 7.93487 14.2857 8.52893 15.1112C8.55757 15.0684 8.58683 15.0249 8.6167 14.9805C9.22537 14.0772 10.0905 12.8515 11.115 11.5648C12.1376 10.2807 13.3313 8.92028 14.5985 7.75607C15.8545 6.60213 17.2406 5.58653 18.6524 5.06272C19.1702 4.87061 19.7457 5.13462 19.9378 5.65241Z" fill="currentColor" />
            </svg>
          </span>
        )}
      </button>
      <button 
        className="dropdown__item"
        onClick={(e) => { e.stopPropagation(); handleSortChange('alphabetical', false); }}
      >
        Z-A
        {sortMode === 'alphabetical' && !ascending && (
          <span className="dropdown__icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="currentColor" fill="none">
              <path fillRule="evenodd" clipRule="evenodd" d="M19.9378 5.65241C20.1299 6.1702 19.8659 6.7457 19.3481 6.93782C18.2893 7.33068 17.1276 8.14841 15.9516 9.22885C14.7868 10.299 13.6643 11.574 12.6796 12.8107C11.6968 14.0449 10.8633 15.2254 10.2753 16.0981C9.98166 16.5339 9.75008 16.8917 9.59261 17.1394C9.51389 17.2632 9.45374 17.3594 9.41368 17.424L9.36885 17.4966L9.35809 17.5142L9.35569 17.5182C9.16686 17.8294 8.82329 18.0143 8.45951 17.9994C8.09567 17.9846 7.76866 17.7732 7.60581 17.4475C6.92848 16.0928 6.15935 15.3411 5.59956 14.934C5.31727 14.7287 5.08223 14.6067 4.93004 14.5391C4.85386 14.5052 4.79837 14.485 4.76806 14.4747C4.75528 14.4703 4.74701 14.4678 4.74357 14.4668C4.2162 14.3269 3.89733 13.7888 4.03009 13.2577C4.16404 12.7219 4.70698 12.3962 5.24277 12.5301C5.26751 12.5366 5.24397 12.5304 5.24397 12.5304L5.24521 12.5307L5.24783 12.5314L5.25365 12.5329L5.26751 12.5366C5.27773 12.5394 5.28991 12.5428 5.30396 12.5469C5.33206 12.5551 5.36767 12.5662 5.41014 12.5805C5.49507 12.6093 5.60755 12.6516 5.74231 12.7115C6.01199 12.8313 6.37071 13.0218 6.77591 13.3165C7.31867 13.7113 7.93487 14.2857 8.52893 15.1112C8.55757 15.0684 8.58683 15.0249 8.6167 14.9805C9.22537 14.0772 10.0905 12.8515 11.115 11.5648C12.1376 10.2807 13.3313 8.92028 14.5985 7.75607C15.8545 6.60213 17.2406 5.58653 18.6524 5.06272C19.1702 4.87061 19.7457 5.13462 19.9378 5.65241Z" fill="currentColor" />
            </svg>
          </span>
        )}
      </button>
    </>
  );

  return (
    <Dropdown 
      className="sort-dropdown"
      open={open}
      onClose={() => setOpen(false)}
      menu={SortMenu}
    >
      {SortTrigger}
    </Dropdown>
  );
};
